<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditel | Sistema de An√°lisis Normativo Inteligente</title>
    <meta name="description" content="Plataforma especializada en an√°lisis normativo autom√°tico para auditor√≠as p√∫blicas">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="main-container">
        <!-- Barra lateral mejorada -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Auditel</h2>
                <p class="sidebar-subtitle">Sistema de An√°lisis Normativo</p>
            </div>

            <div class="sidebar-section">
                <h3>M√≥dulos de An√°lisis</h3>
                <button class="sidebar-button active" data-mode="normativo">
                    <span class="button-icon">‚ñ∏</span>
                    <span class="button-text">An√°lisis Normativo</span>
                </button>
                <button class="sidebar-button" data-mode="sugerencias" onclick="mostrarMensajeDesarrollo()">
                    <span class="button-icon">‚ñ∏</span>
                    <span class="button-text">Planeaci√≥n de Auditor√≠a</span>
                    <span class="badge">Pr√≥ximo</span>
                </button>
            </div>

            <div class="sidebar-section">
                <h3>Bases de Consulta</h3>
                {% for auditoria, stats in estadisticas.items() %}
                <div class="database-info">
                    <div class="db-header">
                        <span class="db-icon">‚óè</span>
                        <span class="db-name">{{ auditoria }}</span>
                    </div>
                    <div class="db-stats">
                        <span class="db-records">{{ stats.registros }} registros</span>
                    </div>
                    <div class="db-desc">{{ stats.descripcion }}</div>
                </div>
                {% endfor %}
            </div>

            <div class="sidebar-footer">
                <div class="system-status">
                    <div class="status-indicator active"></div>
                    <span>Sistema activo</span>
                </div>
                <div class="version">v3.0.0</div>
            </div>
        </div>

        <!-- √Årea de contenido principal mejorada -->
        <div class="content-area">
            <div class="top-bar">
                <div class="top-bar-left">
                    <h1>An√°lisis Normativo Inteligente</h1>
                    <p class="top-bar-subtitle">Sistema de consulta autom√°tica de normativas aplicables</p>
                </div>
                <div class="top-bar-right">
                    <form action="{{ url_for('clear') }}" method="post" class="clear-form">
                        <button type="submit" class="clear-button" title="Iniciar nueva sesi√≥n">
                            <span class="button-icon">‚Üª</span>
                            Nueva Sesi√≥n
                        </button>
                    </form>
                </div>
            </div>

            <div class="chat-container">
                <div class="chat-box" id="chat-box">
                    <!-- Disclaimer integrado en el chat -->
                    <div class="disclaimer-message">
                        <p><strong>Aviso:</strong> La informaci√≥n proporcionada es generada autom√°ticamente y debe ser verificada. No incluye normativa interna espec√≠fica, reglas de operaci√≥n ni convenios particulares.</p>
                    </div>

                    {% if chat_history %}
                        {% for chat in chat_history %}
                            <div class="chat-message user">
                                <div class="message-header">
                                    <span class="message-avatar">üë§</span>
                                    <span class="message-sender">T√∫</span>
                                    <span class="message-time">{{ chat.timestamp|datetimeformat }}</span>
                                </div>
                                <div class="message-content">{{ chat.question }}</div>
                            </div>
                            <div class="chat-message bot">
                                <div class="message-header">
                                    <span class="message-avatar">üîç</span>
                                    <span class="message-sender">Auditel</span>
                                    <span class="message-time">{{ chat.timestamp|datetimeformat }}</span>
                                </div>
                                <div class="message-content">
                                    {{ chat.answer }}
                                </div>
                                <div class="message-context">
                                    <small>Contexto: {{ chat.auditoria }}{% if chat.ente %} ‚Ä¢ {{ chat.ente }}{% endif %} ‚Ä¢ Normativas: {{ chat.normativas_encontradas }}</small>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="welcome-message">
                            <div class="welcome-header">
                                <h3>Bienvenido a Auditel</h3>
                                <p>Sistema especializado en an√°lisis normativo para auditor√≠as p√∫blicas</p>
                            </div>
                            <div class="welcome-features">
                                <div class="feature-card">
                                    <div class="feature-icon">‚ñ∏</div>
                                    <div class="feature-text">
                                        <strong>An√°lisis Autom√°tico</strong>
                                        <span>Detecci√≥n inteligente de normativas aplicables</span>
                                    </div>
                                </div>
                                <div class="feature-card">
                                    <div class="feature-icon">‚ñ∏</div>
                                    <div class="feature-text">
                                        <strong>B√∫squeda Sem√°ntica</strong>
                                        <span>Motor avanzado de similitud conceptual</span>
                                    </div>
                                </div>
                                <div class="feature-card">
                                    <div class="feature-icon">‚ñ∏</div>
                                    <div class="feature-text">
                                        <strong>Base Normativa</strong>
                                        <span>Legislaci√≥n mexicana actualizada</span>
                                    </div>
                                </div>
                                <div class="feature-card">
                                    <div class="feature-icon">‚ñ∏</div>
                                    <div class="feature-text">
                                        <strong>Consulta Especializada</strong>
                                        <span>An√°lisis por tipo de auditor√≠a</span>
                                    </div>
                                </div>
                            </div>
                            <div class="welcome-stats">
                                <div class="stat">
                                    <strong>{{ estadisticas.values()|sum(attribute='registros') }}</strong>
                                    <span>Normativas indexadas</span>
                                </div>
                                <div class="stat">
                                    <strong>{{ estadisticas|length }}</strong>
                                    <span>Tipos de auditor√≠a</span>
                                </div>
                                <div class="stat">
                                    <strong>v3.0</strong>
                                    <span>Versi√≥n actual</span>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <div class="input-area">
                    <form id="ask-form" action="{{ url_for('ask') }}" method="post" class="ask-form">
                        <div class="input-wrapper">
                            <textarea 
                                name="question" 
                                placeholder="Escribe tu consulta sobre normativas aplicables aqu√≠... Ej: '¬øQu√© normativas aplican para licitaciones de obra p√∫blica?'" 
                                required
                                maxlength="2000"
                                aria-label="Consulta sobre normativas"
                            ></textarea>
                            <button type="submit" class="send-button" aria-label="Enviar consulta">
                                <span class="send-icon">‚û§</span>
                            </button>
                        </div>
                        <div class="input-footer">
                            <div class="ai-indicator">
                                <span class="ai-badge">IA</span>
                                <span>An√°lisis inteligente con b√∫squeda sem√°ntica</span>
                            </div>
                            <div class="input-hints">
                                <span class="hint"><strong>Sugerencia:</strong> Utiliza t√©rminos t√©cnicos espec√≠ficos para mejores resultados</span>
                                <span class="hint"><strong>Atajos:</strong> Enter = enviar | Shift+Enter = nueva l√≠nea</span>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts mejorados -->
    <script src="{{ url_for('static', filename='script.js') }}"></script>

    <script>
        // Configuraci√≥n global
        window.auditelConfig = {
            version: '3.0.0',
            maxQuestionLength: 2000,
            supportedAuditorias: {{ auditorias_config|tojson }},
            features: {
                semanticSearch: true,
                patternDetection: true,
                realTimeValidation: true,
                webScraping: true
            }
        };

        function mostrarMensajeDesarrollo() {
            const chatBox = document.getElementById('chat-box');
            const mensaje = document.createElement('div');
            mensaje.className = 'chat-message bot';
            mensaje.innerHTML = `
                <div class="message-header">
                    <span class="message-avatar">‚ñ∏</span>
                    <span class="message-sender">Auditel</span>
                    <span class="message-time">${new Date().toLocaleTimeString()}</span>
                </div>
                <div class="message-content">
                    <div class="feature-coming-soon">
                        <p><strong>M√≥dulo de Planeaci√≥n - En Desarrollo</strong></p>
                        <p>Este m√≥dulo estar√° disponible pr√≥ximamente con las siguientes funcionalidades:</p>
                        <div class="coming-features">
                            <div class="feature-item">‚ñ∏ Generaci√≥n autom√°tica de programas de auditor√≠a</div>
                            <div class="feature-item">‚ñ∏ An√°lisis y detecci√≥n de riesgos</div>
                            <div class="feature-item">‚ñ∏ Recomendaciones de procedimientos espec√≠ficos</div>
                        </div>
                        <p>Actualmente puede utilizar el <strong>M√≥dulo de An√°lisis Normativo</strong> para consultar regulaciones aplicables.</p>
                    </div>
                </div>
            `;
            chatBox.appendChild(mensaje);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Procesar markdown en mensajes existentes despu√©s de cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof marked !== 'undefined') {
                marked.setOptions({
                    breaks: true,
                    gfm: true,
                    sanitize: false,  // ‚úÖ IMPORTANTE: Permitir HTML
                    headerIds: true
                });

                // Procesar markdown en todos los mensajes existentes del historial
                const messageContents = document.querySelectorAll('.message-content');
                messageContents.forEach(element => {
                    if (!element.classList.contains('processed')) {
                        const originalContent = element.innerHTML;
                        try {
                            element.innerHTML = marked.parse(originalContent);
                            element.classList.add('processed');
                        } catch (error) {
                            console.error('Error procesando markdown:', error);
                            element.innerHTML = originalContent;
                        }
                    }
                });
            }

            // Mejorar accesibilidad
            const mainContainer = document.querySelector('.main-container');
            if (mainContainer) {
                mainContainer.setAttribute('role', 'main');
                mainContainer.setAttribute('aria-label', 'Sistema de an√°lisis normativo Auditel');
            }

            console.log('Auditel v3.0 - Sistema inicializado');
            console.log('Configuraci√≥n:', window.auditelConfig);
        });
    </script>
</body>
</html>
